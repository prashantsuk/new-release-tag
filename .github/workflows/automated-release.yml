# .github/workflows/automated-release.yml
# This is the ONLY approved way to create release tags

name: Automated Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., 1.0.0, 2.1.3)'
        required: true
        type: string
      pre_release:
        description: 'Mark as pre-release?'
        required: false
        default: false
        type: boolean
      release_notes:
        description: 'Additional release notes (optional)'
        required: false
        type: string

  # Auto-trigger when feature branches are merged to main/master
  push:
    branches:
      - main
      - master
    paths:
      - 'package.json'
      - 'version.txt'
      - 'VERSION'
      - 'pom.xml'

  # Also trigger on pull request merge to main/master
  pull_request:
    types: [closed]
    branches:
      - main
      - master

env:
  AUTOMATED_RELEASE: true  # This flag identifies automated releases

jobs:
  validate-and-release:
    runs-on: ubuntu-latest
    # Only run on main/master branch and for merged PRs
    if: |
      (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master') &&
      (github.event_name == 'workflow_dispatch' || 
       github.event_name == 'push' ||
       (github.event_name == 'pull_request' && github.event.pull_request.merged == true))
    permissions:
      contents: write
      issues: write
      pull-requests: read
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Check trigger context
        id: trigger_context
        run: |
          echo "üîç Checking release trigger context..."
          echo "Event: ${{ github.event_name }}"
          echo "Branch: ${{ github.ref }}"
          echo "Actor: ${{ github.actor }}"
          
          # Check if this is a valid trigger for release
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "‚úÖ Manual workflow dispatch - release allowed"
            echo "trigger_type=manual" >> $GITHUB_OUTPUT
            echo "should_release=true" >> $GITHUB_OUTPUT
          elif [[ "${{ github.event_name }}" == "pull_request" && "${{ github.event.pull_request.merged }}" == "true" ]]; then
            echo "‚úÖ Pull request merged to ${{ github.base_ref }} - checking for release triggers"
            echo "trigger_type=pr_merged" >> $GITHUB_OUTPUT
            echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
            echo "pr_title=${{ github.event.pull_request.title }}" >> $GITHUB_OUTPUT
            echo "source_branch=${{ github.event.pull_request.head.ref }}" >> $GITHUB_OUTPUT
            
            # Check if PR title contains release keywords
            PR_TITLE="${{ github.event.pull_request.title }}"
            if [[ "$PR_TITLE" =~ (release|Release|RELEASE|version|Version|v[0-9]) ]] || 
               [[ "${{ github.event.pull_request.head.ref }}" =~ (release|hotfix|feature) ]]; then
              echo "‚úÖ PR contains release indicators - will check for version changes"
              echo "should_release=check_version" >> $GITHUB_OUTPUT
            else
              echo "‚ÑπÔ∏è PR does not contain release indicators - skipping auto-release"
              echo "should_release=false" >> $GITHUB_OUTPUT
            fi
          elif [[ "${{ github.event_name }}" == "push" ]]; then
            echo "‚úÖ Direct push to main/master with version file changes"
            echo "trigger_type=push" >> $GITHUB_OUTPUT
            echo "should_release=check_version" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Invalid trigger context"
            echo "should_release=false" >> $GITHUB_OUTPUT
          fi

      - name: Determine version
        id: version
        if: steps.trigger_context.outputs.should_release != 'false'
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            VERSION="${{ github.event.inputs.version }}"
            echo "üìù Manual version input: $VERSION"
          else
            # Auto-detect version from files for PR merges and pushes
            if [[ -f "package.json" ]]; then
              VERSION=$(jq -r '.version' package.json)
              echo "üì¶ Version from package.json: $VERSION"
            elif [[ -f "version.txt" ]]; then
              VERSION=$(cat version.txt | tr -d '\n\r')
              echo "üìÑ Version from version.txt: $VERSION"
            elif [[ -f "VERSION" ]]; then
              VERSION=$(cat VERSION | tr -d '\n\r')
              echo "üìÑ Version from VERSION file: $VERSION"
            elif [[ -f "pom.xml" ]]; then
              VERSION=$(grep -oP '(?<=<version>)[^<]+' pom.xml | head -1)
              echo "‚òï Version from pom.xml: $VERSION"
            else
              echo "‚ùå No version file found and no manual input provided"
              if [[ "${{ steps.trigger_context.outputs.should_release }}" == "check_version" ]]; then
                echo "‚ÑπÔ∏è Skipping release - no version file changes detected"
                echo "skip_release=true" >> $GITHUB_OUTPUT
                exit 0
              else
                exit 1
              fi
            fi
            
            # For automatic triggers, check if version actually changed
            if [[ "${{ steps.trigger_context.outputs.should_release }}" == "check_version" ]]; then
              LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
              LAST_VERSION=${LAST_TAG#v}
              
              if [[ "$VERSION" == "$LAST_VERSION" ]]; then
                echo "‚ÑπÔ∏è Version hasn't changed ($VERSION) - skipping release"
                echo "skip_release=true" >> $GITHUB_OUTPUT
                exit 0
              else
                echo "‚úÖ Version changed from $LAST_VERSION to $VERSION - proceeding with release"
              fi
            fi
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üéØ Release version: $VERSION"

      - name: Skip release notification
        if: steps.version.outputs.skip_release == 'true'
        run: |
          echo "## ‚ÑπÔ∏è Release Skipped" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** No version changes detected" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ steps.trigger_context.outputs.trigger_type }}" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.trigger_context.outputs.trigger_type }}" == "pr_merged" ]]; then
            echo "**PR:** #${{ steps.trigger_context.outputs.pr_number }} - ${{ steps.trigger_context.outputs.pr_title }}" >> $GITHUB_STEP_SUMMARY
            echo "**Source Branch:** ${{ steps.trigger_context.outputs.source_branch }}" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "To create a release, update the version in your version file and merge the changes." >> $GITHUB_STEP_SUMMARY

      - name: Validate version format
        if: steps.version.outputs.skip_release != 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          
          # Remove 'v' prefix if present
          VERSION=${VERSION#v}
          
          # Check semantic versioning format
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9]+)?$ ]]; then
            echo "::error::‚ùå Invalid version format: $VERSION"
            echo "::error::Version must be in format X.Y.Z or X.Y.Z-suffix (e.g., 1.0.0, 2.1.3-beta)"
            exit 1
          fi
          
          echo "‚úÖ Version format is valid: $VERSION"

      - name: Check if tag already exists
        if: steps.version.outputs.skip_release != 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="v${VERSION#v}"  # Ensure 'v' prefix
          
          if git tag -l | grep -q "^$TAG$"; then
            echo "::error::‚ùå Tag $TAG already exists!"
            echo "::error::Please use a different version number."
            exit 1
          fi
          
          echo "‚úÖ Tag $TAG is available"

      - name: Get commit range for changelog
        id: commit_range
        if: steps.version.outputs.skip_release != 'true'
        run: |
          # Get the last tag
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          
          if [[ -n "$LAST_TAG" ]]; then
            echo "last_tag=$LAST_TAG" >> $GITHUB_OUTPUT
            echo "üìä Last tag: $LAST_TAG"
          else
            echo "last_tag=" >> $GITHUB_OUTPUT
            echo "üìä No previous tags found (first release)"
          fi

      - name: Generate changelog
        id: changelog
        if: steps.version.outputs.skip_release != 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          LAST_TAG="${{ steps.commit_range.outputs.last_tag }}"
          
          echo "üìù Generating changelog..."
          
          # Start changelog
          echo "## üöÄ Release v$VERSION" > changelog.md
          echo "" >> changelog.md
          
          # Add manual release notes if provided
          if [[ -n "${{ github.event.inputs.release_notes }}" ]]; then
            echo "### üìã Release Notes" >> changelog.md
            echo "${{ github.event.inputs.release_notes }}" >> changelog.md
            echo "" >> changelog.md
          fi
          
          # Generate automatic changelog with PR information
          echo "### üì¶ Changes" >> changelog.md
          
          if [[ -n "$LAST_TAG" ]]; then
            echo "Changes since $LAST_TAG:" >> changelog.md
            echo "" >> changelog.md
            
            # Get commits with nice formatting
            git log --oneline --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" $LAST_TAG..HEAD >> changelog.md
            
            # Add PR information if this was triggered by PR merge
            if [[ "${{ steps.trigger_context.outputs.trigger_type }}" == "pr_merged" ]]; then
              echo "" >> changelog.md
              echo "### üîÄ Merged Pull Requests" >> changelog.md
              echo "- #${{ steps.trigger_context.outputs.pr_number }}: ${{ steps.trigger_context.outputs.pr_title }}" >> changelog.md
              echo "- Source branch: \`${{ steps.trigger_context.outputs.source_branch }}\`" >> changelog.md
            fi
            
            # Add contributors
            echo "" >> changelog.md
            echo "### üë• Contributors" >> changelog.md
            git log --format='- @%an' $LAST_TAG..HEAD | sort -u >> changelog.md
          else
            echo "Initial release" >> changelog.md
            echo "" >> changelog.md
            git log --oneline --pretty=format:"- %s ([%h](https://github.com/${{ github.repository }}/commit/%H))" HEAD~10..HEAD >> changelog.md
          fi
          
          # Add comparison link
          echo "" >> changelog.md
          if [[ -n "$LAST_TAG" ]]; then
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$LAST_TAG...v$VERSION" >> changelog.md
          fi
          
          # Output for GitHub Actions
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat changelog.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "‚úÖ Changelog generated successfully"

      - name: Create release tag
        if: steps.version.outputs.skip_release != 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="v${VERSION#v}"
          
          # Configure git with bot identity
          git config --global user.name "github-actions[bot]"
          git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Create annotated tag with automation marker and trigger info
          TRIGGER_INFO=""
          if [[ "${{ steps.trigger_context.outputs.trigger_type }}" == "pr_merged" ]]; then
            TRIGGER_INFO="
          Triggered by: PR #${{ steps.trigger_context.outputs.pr_number }} merge
          PR Title: ${{ steps.trigger_context.outputs.pr_title }}
          Source Branch: ${{ steps.trigger_context.outputs.source_branch }}"
          elif [[ "${{ steps.trigger_context.outputs.trigger_type }}" == "push" ]]; then
            TRIGGER_INFO="
          Triggered by: Direct push to ${{ github.ref_name }}"
          elif [[ "${{ steps.trigger_context.outputs.trigger_type }}" == "manual" ]]; then
            TRIGGER_INFO="
          Triggered by: Manual workflow dispatch"
          fi
          
          git tag -a "$TAG" -m "Release $TAG [automated-release]

          This release was created automatically via GitHub Actions.
          
          Version: $VERSION
          Workflow: ${{ github.workflow }}
          Run ID: ${{ github.run_id }}
          Actor: ${{ github.actor }}$TRIGGER_INFO
          "
          
          # Push the tag
          git push origin "$TAG"
          
          echo "‚úÖ Created and pushed tag: $TAG"
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Create GitHub Release
        uses: actions/create-release@v1
        id: create_release
        if: steps.version.outputs.skip_release != 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ steps.version.outputs.version }}
          release_name: üöÄ Release v${{ steps.version.outputs.version }}
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: ${{ github.event.inputs.pre_release }}

      - name: Output release information
        if: steps.version.outputs.skip_release != 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          RELEASE_URL="${{ steps.create_release.outputs.html_url }}"
          
          echo "## üéâ Release Created Successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** v$VERSION" >> $GITHUB_STEP_SUMMARY
          echo "**Release URL:** $RELEASE_URL" >> $GITHUB_STEP_SUMMARY
          echo "**Pre-release:** ${{ github.event.inputs.pre_release }}" >> $GITHUB_STEP_SUMMARY
          echo "**Trigger:** ${{ steps.trigger_context.outputs.trigger_type }}" >> $GITHUB_STEP_SUMMARY
          
          # Add trigger-specific information
          if [[ "${{ steps.trigger_context.outputs.trigger_type }}" == "pr_merged" ]]; then
            echo "**Merged PR:** #${{ steps.trigger_context.outputs.pr_number }} - ${{ steps.trigger_context.outputs.pr_title }}" >> $GITHUB_STEP_SUMMARY
            echo "**Source Branch:** ${{ steps.trigger_context.outputs.source_branch }}" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üîó Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [üìã View Release]($RELEASE_URL)" >> $GITHUB_STEP_SUMMARY
          echo "- [üì¶ Download Assets]($RELEASE_URL)" >> $GITHUB_STEP_SUMMARY
          echo "- [üè∑Ô∏è All Releases](https://github.com/${{ github.repository }}/releases)" >> $GITHUB_STEP_SUMMARY
          
          echo "üéØ Release v$VERSION created successfully!"
          echo "üîó Release URL: $RELEASE_URL"
