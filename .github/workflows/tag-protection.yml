# .github/workflows/tag-protection.yml
# This workflow prevents manual tag creation and only allows automated releases

name: Tag Protection

on:
  create:
    tags:
      - 'v*'              # Version tags like v1.0.0, v2.1.3
      - 'release-*'       # Release tags like release-1.0.0
      - '*.*.*'           # Semantic version tags like 1.0.0

jobs:
  validate-tag-creation:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Validate tag creation source
        id: validate
        run: |
          echo "ðŸ” Checking tag creation context..."
          echo "Event: ${{ github.event_name }}"
          echo "Actor: ${{ github.actor }}"
          echo "Tag: ${{ github.ref_name }}"
          echo "Workflow: ${{ github.workflow }}"
          echo "Repository: ${{ github.repository }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Event Name: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Ref Type: ${{ github.ref_type }}"
          
          # Get the commit that created this tag
          TAG_COMMIT=$(git rev-list -n 1 ${{ github.ref_name }} 2>/dev/null || echo "unknown")
          echo "Tag points to commit: $TAG_COMMIT"
          
          # Get the commit message for the tagged commit
          if [[ "$TAG_COMMIT" != "unknown" ]]; then
            COMMIT_MSG=$(git log -1 --pretty=%B $TAG_COMMIT 2>/dev/null || echo "")
            echo "Commit message: $COMMIT_MSG"
          else
            COMMIT_MSG=""
            echo "Could not retrieve commit message"
          fi
          
          # Get tag annotation message if it exists
          TAG_MESSAGE=$(git tag -l --format='%(contents)' ${{ github.ref_name }} 2>/dev/null || echo "")
          echo "Tag annotation: $TAG_MESSAGE"
          
          # The key logic: Check if tag was created by our Automated Release workflow
          # Method 1: Check if tag annotation contains our automation marker
          if [[ "$TAG_MESSAGE" =~ \[automated-release\] ]]; then
            echo "âœ… Tag annotation contains automation marker - allowing"
            echo "allowed=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Method 2: Check if recent commits contain automation marker
          echo "ðŸ” Checking recent commits for automation markers..."
          RECENT_AUTOMATION=$(git log --oneline -10 --grep="\[automated-release\]" 2>/dev/null || echo "")
          if [[ -n "$RECENT_AUTOMATION" ]]; then
            echo "âœ… Found recent automation commit: $RECENT_AUTOMATION"
            
            # Check if the tag points to one of these automation commits
            if echo "$RECENT_AUTOMATION" | grep -q "$TAG_COMMIT"; then
              echo "âœ… Tag points to automation commit - allowing"
              echo "allowed=true" >> $GITHUB_OUTPUT
              exit 0
            fi
          fi
          
          # Method 3: Check if commit message contains automation marker
          if [[ "$COMMIT_MSG" =~ \[automated-release\] ]]; then
            echo "âœ… Commit message contains automation marker - allowing"
            echo "allowed=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Method 4: Check if this is triggered by workflow_run (from another workflow)
          if [[ "${{ github.event_name }}" == "workflow_run" ]]; then
            echo "âœ… Triggered by workflow_run - allowing"
            echo "allowed=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Method 5: Check timing - if a recent commit (last 5 minutes) has automation marker
          echo "ðŸ” Checking for recent automation activity..."
          FIVE_MINUTES_AGO=$(date -d '5 minutes ago' +%s 2>/dev/null || date -v-5M +%s 2>/dev/null || echo "0")
          RECENT_COMMITS=$(git log --since="5 minutes ago" --oneline --grep="\[automated-release\]" 2>/dev/null || echo "")
          if [[ -n "$RECENT_COMMITS" ]]; then
            echo "âœ… Found recent automation activity (last 5 minutes) - allowing"
            echo "Recent automation commits: $RECENT_COMMITS"
            echo "allowed=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          # Method 6: Special case - if actor is github-actions[bot] but verify it's really automated
          if [[ "${{ github.actor }}" == "github-actions[bot]" ]]; then
            echo "âš ï¸ Actor is github-actions[bot] - need to verify if truly automated"
            
            # Check if there are any automation markers in recent history
            if [[ -n "$RECENT_AUTOMATION" ]] || [[ "$TAG_MESSAGE" =~ (automated|release|bot) ]] || [[ "$COMMIT_MSG" =~ (automated|release|bot) ]]; then
              echo "âœ… Bot actor with automation evidence - allowing"
              echo "allowed=true" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "âŒ Bot actor but no automation evidence - treating as manual"
            fi
          fi
          
          # If we reach here, it's likely a manual tag creation
          echo "âŒ MANUAL TAG CREATION DETECTED!"
          echo "âŒ Tag '${{ github.ref_name }}' appears to be created manually"
          echo "âŒ Actor: ${{ github.actor }}"
          echo "âŒ No automation markers found in:"
          echo "   - Tag annotation"
          echo "   - Commit messages"
          echo "   - Recent automation activity"
          echo "âŒ This tag will be deleted!"
          echo "allowed=false" >> $GITHUB_OUTPUT

      - name: Delete manual tag and create notification
        if: steps.validate.outputs.allowed == 'false'
        run: |
          TAG_NAME="${{ github.ref_name }}"
          CREATOR="${{ github.actor }}"
          
          echo "::error::ðŸš« Manual tag creation is not allowed!"
          echo "::error::Tag '$TAG_NAME' was created manually by $CREATOR"
          echo "::error::Please use the 'Automated Release' workflow instead."
          
          # Show current repository state for debugging
          echo "ðŸ” Repository state:"
          echo "Branch: $(git branch --show-current 2>/dev/null || echo 'detached')"
          echo "Last 3 commits:"
          git log --oneline -3 || echo "No commits found"
          echo "All tags:"
          git tag -l || echo "No tags found"
          
          # Configure git
          git config --global user.name "GitHub Actions Tag Protection"
          git config --global user.email "actions@github.com"
          
          # Delete the manually created tag
          echo "ðŸ—‘ï¸ Attempting to delete manual tag: $TAG_NAME"
          echo "ðŸ” Current git state before deletion:"
          git tag -l | grep "$TAG_NAME" || echo "Tag not found locally"
          
          # Method 1: Delete using git push
          echo "Method 1: Deleting via git push..."
          if git push origin :refs/tags/$TAG_NAME 2>&1; then
            echo "âœ… Successfully deleted tag $TAG_NAME from remote using git push"
            DELETION_SUCCESS=true
          else
            echo "âŒ Failed to delete tag using git push"
            DELETION_SUCCESS=false
          fi
          
          # Method 2: Delete using GitHub API if git push failed
          if [[ "$DELETION_SUCCESS" != "true" ]]; then
            echo "Method 2: Deleting via GitHub API..."
            if gh api -X DELETE "repos/${{ github.repository }}/git/refs/tags/$TAG_NAME" 2>&1; then
              echo "âœ… Successfully deleted tag $TAG_NAME using GitHub API"
              DELETION_SUCCESS=true
            else
              echo "âŒ Failed to delete tag using GitHub API"
            fi
          fi
          
          # Method 3: Force delete with alternative API endpoint
          if [[ "$DELETION_SUCCESS" != "true" ]]; then
            echo "Method 3: Force delete via alternative API..."
            TAG_SHA=$(gh api "repos/${{ github.repository }}/git/refs/tags/$TAG_NAME" --jq '.object.sha' 2>/dev/null || echo "")
            if [[ -n "$TAG_SHA" ]]; then
              if gh api -X DELETE "repos/${{ github.repository }}/git/refs/tags/$TAG_NAME" -f sha="$TAG_SHA" 2>&1; then
                echo "âœ… Successfully force deleted tag $TAG_NAME"
                DELETION_SUCCESS=true
              fi
            fi
          fi
          
          # Check if tag still exists
          echo "ðŸ” Verifying tag deletion..."
          sleep 2  # Wait a moment for GitHub to process
          if gh api "repos/${{ github.repository }}/git/refs/tags/$TAG_NAME" 2>/dev/null; then
            echo "âš ï¸ Tag still exists after deletion attempts"
            DELETION_STATUS="âŒ Failed to delete (tag still exists)"
          else
            echo "âœ… Tag successfully deleted and no longer exists"
            DELETION_STATUS="âœ… Successfully deleted"
          fi
          
          # Create an issue to notify about the blocked attempt
          cat > issue_body.md << EOF
          ## ðŸš« Manual Tag Creation Blocked
          
          **Tag:** \`$TAG_NAME\`  
          **Created by:** @$CREATOR  
          **Time:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")  
          **Event:** ${{ github.event_name }}  
          **Workflow Run:** [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})  
          **Deletion Status:** $DELETION_STATUS
          
          ### âŒ What happened?
          The tag \`$TAG_NAME\` was created manually and our automation detected it.
          **Action taken:** Attempted automatic deletion.
          
          ### ðŸ” Detection Details
          - **Actor:** ${{ github.actor }}
          - **Event:** ${{ github.event_name }}
          - **Tag Commit:** $TAG_COMMIT
          - **No automation markers found in tag or recent commits**
          
          ### âœ… How to create releases properly?
          
          **Option 1: Use the Automated Release Workflow**
          1. Go to **[Actions â†’ Automated Release](https://github.com/${{ github.repository }}/actions/workflows/automated-release.yml)**
          2. Click **"Run workflow"**
          3. Enter the version number (e.g., \`1.0.3\`)
          4. Click **"Run workflow"**
          
          **Option 2: Update VERSION file and merge PR**
          1. Create a feature branch
          2. Update the \`VERSION\` file with your desired version (e.g., \`1.0.3\`)
          3. Create and merge a PR to main/master
          4. Release will be created automatically
          
          ### ðŸ”§ Why this restriction exists?
          - âœ… Ensures consistent release process
          - âœ… Automatically generates changelogs
          - âœ… Maintains proper version history
          - âœ… Prevents accidental or malformed releases
          - âœ… Tracks release triggers and contexts
          
          ### ðŸš¨ If this was a legitimate automated release
          If you believe this tag was created by automation but was incorrectly flagged:
          1. Check that your automation includes the \`[automated-release]\` marker
          2. Verify the tag annotation contains automation markers
          3. Contact the DevOps team for investigation
          
          ### ðŸ“‹ Need help?
          - Check the repository's release documentation
          - Contact the DevOps team
          - Review existing releases for examples
          
          ---
          *This issue was created automatically by the Tag Protection workflow.*
          *Workflow Run: ${{ github.run_id }}*
          EOF
          
          # Create the notification issue (with error handling)
          if gh issue create \
            --title "ðŸš« Manual tag creation blocked: $TAG_NAME" \
            --body-file issue_body.md \
            --label "automation,release,blocked" \
            --assignee "$CREATOR" 2>/dev/null; then
            echo "ðŸ“ Created notification issue for $CREATOR"
          else
            echo "âš ï¸ Failed to create issue, but tag deletion was attempted"
            # Try without assignee in case user doesn't exist
            gh issue create \
              --title "ðŸš« Manual tag creation blocked: $TAG_NAME" \
              --body-file issue_body.md \
              --label "automation,release,blocked" 2>/dev/null || echo "Failed to create issue entirely"
          fi
          
          # Fail the workflow to show it clearly in the Actions tab
          echo "::error::Manual tag creation blocked and tag deleted"
          exit 1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Log successful automation
        if: steps.validate.outputs.allowed == 'true'
        run: |
          echo "âœ… Tag creation validated successfully"
          echo "âœ… Tag '${{ github.ref_name }}' created by automation"
          echo "âœ… Release process completed properly"
