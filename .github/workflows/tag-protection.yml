# .github/workflows/tag-protection.yml
# This workflow prevents manual tag creation and only allows automated releases

name: Tag Protection

on:
  create:
    tags:
      - 'v*'              # Version tags like v1.0.0, v2.1.3
      - 'release-*'       # Release tags like release-1.0.0
      - '*.*.*'           # Semantic version tags like 1.0.0

jobs:
  validate-tag-creation:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ULTRA STRICT Tag Validation
        id: validate
        run: |
          echo "🔍 ULTRA STRICT TAG VALIDATION - Version 2.0"
          echo "============================================="
          echo "Tag: ${{ github.ref_name }}"
          echo "Actor: ${{ github.actor }}"
          echo "Event: ${{ github.event_name }}"
          echo "Time: $(date -u)"
          
          # Force display this validation is running
          echo "::notice::🔍 Tag Protection validation is running for ${{ github.ref_name }}"
          
          # Get tag annotation - this is the ONLY thing that matters
          TAG_MESSAGE=$(git tag -l --format='%(contents)' ${{ github.ref_name }} 2>/dev/null || echo "")
          
          echo ""
          echo "📝 Tag annotation content:"
          if [[ -n "$TAG_MESSAGE" ]]; then
            echo "\"$TAG_MESSAGE\""
          else
            echo "(no annotation - this is a manual tag)"
          fi
          
          echo ""
          echo "🔍 Checking for [automated-release] marker..."
          
          # THE ONLY VALIDATION: Check for exact [automated-release] marker
          if [[ -n "$TAG_MESSAGE" && "$TAG_MESSAGE" =~ \[automated-release\] ]]; then
            echo "✅ AUTOMATION DETECTED: Tag contains [automated-release] marker"
            echo "✅ This tag is ALLOWED"
            echo "allowed=true" >> $GITHUB_OUTPUT
          else
            echo "❌ MANUAL TAG DETECTED: No [automated-release] marker found"
            echo "❌ This tag will be DELETED immediately"
            echo "allowed=false" >> $GITHUB_OUTPUT
          fi
          
          echo ""
          echo "🎯 FINAL DECISION:"
          if [[ -n "$TAG_MESSAGE" && "$TAG_MESSAGE" =~ \[automated-release\] ]]; then
            echo "RESULT: ALLOW (automation marker found)"
          else
            echo "RESULT: BLOCK AND DELETE (manual tag)"
          fi

      - name: Allow Automated Tag
        if: steps.validate.outputs.allowed == 'true'
        run: |
          echo "✅ AUTOMATED TAG ALLOWED"
          echo "✅ Tag '${{ github.ref_name }}' contains automation markers"
          echo "✅ Tag creation permitted - no action needed"

      - name: Block and Delete Manual Tag
        if: steps.validate.outputs.allowed == 'false'
        run: |
          TAG_NAME="${{ github.ref_name }}"
          
          echo "🚫 MANUAL TAG BLOCKED!"
          echo "::error::Manual tag '$TAG_NAME' is NOT ALLOWED"
          echo "::error::Deleting tag immediately"
          
          # Configure git
          git config --global user.name "Tag Protection Bot"
          git config --global user.email "tag-protection@github.com"
          
          # Delete the tag
          echo "🗑️ Deleting manual tag: $TAG_NAME"
          
          if git push origin :refs/tags/$TAG_NAME 2>&1; then
            echo "✅ Manual tag deleted successfully"
          else
            echo "❌ Failed to delete with git push, trying API..."
            gh api -X DELETE "repos/${{ github.repository }}/git/refs/tags/$TAG_NAME" || echo "API deletion also failed"
          fi
          
          # Verify deletion
          sleep 2
          if gh api "repos/${{ github.repository }}/git/refs/tags/$TAG_NAME" >/dev/null 2>&1; then
            echo "⚠️ Tag still exists - deletion may have failed"
          else
            echo "✅ Confirmed: Tag successfully deleted"
          fi
          
          # Create summary
          echo "## 🚫 Manual Tag Blocked" >> $GITHUB_STEP_SUMMARY
          echo "**Tag:** \`$TAG_NAME\`" >> $GITHUB_STEP_SUMMARY
          echo "**Actor:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** Deleted" >> $GITHUB_STEP_SUMMARY
          echo "**Reason:** No [automated-release] annotation found" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Use the **Automated Release** workflow to create releases properly." >> $GITHUB_STEP_SUMMARY
          
          # Fail the workflow to show blocking occurred
          echo "::error::Manual tag blocked and deleted"
          exit 1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
